---
permalink: 数据库/语法
aliases:
  - Bases syntax
  - Bases file format
  - bases/syntax
---
当你在 Obsidian 中 [[创建数据库]] 时，它会被保存为一个 `.base` 文件。通常，数据库在应用中通过图形界面编辑，但你也可以手动编辑它的语法，或将其插入到一个代码块中。

[[数据库功能简介|数据库]] 语法决定了 [[视图]]，筛选，和公式。数据库必须是遵从下方定义的数据结构规范的有效 YAML。

## 示例

这是一个数据库文件的示例，我们会逐个详细介绍每个部分。

```yaml
filters:
  or:
    - file.hasTag("tag")
    - and:
        - file.hasTag("book")
        - file.hasLink("Textbook")
    - not:
        - file.hasTag("book")
        - file.inFolder("Required Reading")
formulas:
  formatted_price: 'if(price, price.toFixed(2) + " dollars")'
  ppu: "(price / age).toFixed(2)"
properties:
  status:
    displayName: Status
  formula.formatted_price:
    displayName: "Price"
  file.ext:
    displayName: Extension
views:
  - type: table
    name: "My table"
    limit: 10
    filters:
      and:
        - 'status != "done"'
        - or:
            - "formula.ppu > 5"
            - "price > 2.1"
    order:
      - file.name
      - file.ext
      - note.age
      - formula.ppu
      - formula.formatted_price
```

### 筛选

默认情况下，数据库中包含了仓库中的所有文件。与 SQL 或者 Dataview 不同，它没有 `from` 或者 `source`。通过使用 `filters` 节，你可以定义条件，缩小数据集的范围。

```yaml
filters:
  or:
    - file.hasTag("标签")
    - and:
        - file.hasTag("书籍")
        - file.hasLink("课本")
    - not:
        - file.hasTag("书籍")
        - file.inFolder("待阅读")
```

你可以在两处应用筛选：

1. 在全局的 `filters` 层级（就像上面所展示的那样），这会对数据库里的所有视图生效。
2. 在 `view` 层级，只对某个特定视图生效。

这两部分在功能上是等效的。在实际应用到视图上时，它们会通过 `AND` 串联起来。

`filters` 节包含单个字符串形式的筛选语句，或者递归定义的筛选对象。筛选对象可能包含 `and`、`or` 或 `not` 中的一个。这些键是其他筛选对象或字符串形式的筛选语句的异构列表。筛选语句是一行代码，当应用到笔记时会求值为真或假。它可以是以下之一：

- 使用标准算术运算符的基本比较。
- 一个函数。Obsidian 内置了多种 [[函数]]，插件也可以添加额外的函数。

筛选和公式的语法和可用函数是相同的。

### 公式

`formulas` 节定义了可以在数据库文件的所有视图中显示的公式属性。

```yaml
formulas:
  格式化价格: 'if(价格, 价格.toFixed(2) + " 元")'
  单价: "(价格 / 使用年限).toFixed(2)"
```

公式属性支持基本的算术运算符和多种内置 [[函数]]。未来，插件将能够为公式添加可用的函数。

你可以根据属性的类型以不同的方式引用它们：

- **笔记（note）属性** 是定义在笔记的元数据（frontmatter）中的属性。例如 `note.价格` 或 `note["价格"]`。  
  如果一个属性未指定前缀，则其将被假定为 `note` 属性。
- **文件（file）属性** 描述文件本身。  
  例如 `file.size`（文件体积）或 `file.ext`（文件扩展名）。你还可以直接引用文件对象，例如 `file.hasLink()`。
- **公式（formula）属性** 是数据库文件中的其他公式。  
  例如 `formula.格式化价格`。

  公式可以使用其他公式属性的值，只要没有循环引用即可。

  公式属性始终以字符串形式存储在 YAML 中，但它们的实际 **输出数据类型** 由底层数据的类型和所使用函数的返回值决定。

注意：在 YAML 字段中包含文本字面量时，需要使用嵌套引号。文本字面量必须用单引号或双引号括起来。

### 属性

`properties` 节允许存储关于每个属性的配置信息。具体视图可以按需使用这些配置信息。例如，在表格中，显示名称用于列标题。

```yaml
properties:
  状态:
    displayName: 任务状态
  formula.格式化价格:
    displayName: "价格"
  file.ext:
    displayName: 扩展名
```

显示名称不会在筛选器或公式中使用。

### 视图

`views` 节定义了数据的渲染方式。`views` 列表中的每个条目定义了同一数据的一个单独视图，若有需要，你可以定义多个不同视图。

```yaml
views:
  - type: table
    name: "我的表格"
    limit: 10
    filters:
      and:
        - '状态 != "完成"'
        - or:
            - "formula.单价 > 5"
            - "价格 > 2.1"
    order:
      - file.name
      - file.ext
      - note.age
      - formula.单价
      - formula.格式化价格
```

- `type` 从内置和插件添加的视图类型中选择。
- `name` 是显示名称，可用于定义默认视图。
- `filters` 与上文描述的完全相同，但仅适用于该视图。

[[视图]] 可以添加额外的数据以存储任何需要的信息，用于维护状态或正确渲染。然而，插件作者应注意不要使用数据库核心插件已使用的键。例如，表格（table）视图可能会使用这些数据来限制行数，或者选择用于排序行的列及其方向。另一种视图类型（如地图）可以使用这些数据来映射笔记中的属性到纬度和经度，并将某个属性显示为标记标题。

未来，API 将允许视图读取和写入这些值，从而使视图能够构建自己的配置界面。

## 属性

数据库中使用了三种类型的属性：

1. **笔记（note）属性**，存储在 Markdown 文件的元数据（frontmatter）中。
2. **文件（file）属性**，可用于所有文件类型。
3. **公式（formula）属性**，定义在 `.base` 文件本身中（见上文）。

### 笔记属性

[[属性|笔记属性]] 仅适用于 Markdown 文件，并存储在每个笔记的 YAML 元数据中。这些属性可以通过 `note.作者` 的格式访问，或者简单地使用 `作者` 作为简写。

### 文件属性

文件属性指的是当前正在测试或处理的文件。这些属性适用于所有 [[接受的文件格式|文件类型]]，包括附件。

例如，筛选器 `file.ext == "md"` 对所有 Markdown 文件返回 true，否则返回 false。

| 属性 | 类型 | 描述 |
| --------------- | ------ | -------------------------------------------------------------------- |
| `file.backlinks` | 列表 | 反向链接文件的列表。注意：此属性性能较低。尽可能反向查找并使用 `file.links`。该结果在仓库更改时不会自动刷新。 |
| `file.ctime` | 日期 | 创建时间 |
| `file.embeds` | 列表 | 笔记中所有嵌入内容的列表 |
| `file.ext` | 字符串 | 文件扩展名 |
| `file.file` | 文件   | 文件对象，仅在特定函数中可用 |
| `file.folder` | 字符串 | 文件夹路径 |
| `file.links` | 列表 | 笔记中所有内部链接的列表，包括元数据 |
| `file.mtime` | 日期 | 修改时间 |
| `file.name` | 字符串 | 文件名 |
| `file.path` | 字符串 | 文件路径 |
| `file.properties` | 对象 | 文件上的所有属性。注意：该结果在仓库更改时不会自动刷新。 |
| `file.size` | 数字 | 文件大小 |
| `file.tags` | 列表 | 文件内容和元数据中的所有标签列表 |

### 访问当前文件的属性

嵌入的数据库可以使用 `this` 访问当前文件的属性。例如，`this.file.name` 将解析为嵌入该数据库的文件的名称，而不是正在处理的文件。

在侧边栏中，`this` 具有“当前活动文件”的特殊含义。这允许你基于主内容区域中的活动文件创建上下文查询。例如，可以使用以下筛选器复制反向链接面板：`file.hasLink(this.file)`。

## 运算符

### 算术运算符

算术运算符对数字执行算术运算。例如，`半径 * (2 * 3.14)`。

| 运算符 | 描述 |
| ------ | ---- |
| `+`    | 加    |
| `-`    | 减    |
| `*`    | 乘    |
| `/`    | 除    |
| `%`    | 取模  |
| `( )`  | 括号  |

### 日期算术

通过加减一个时间间隔，可以修改日期。时间间隔单位接受多种格式：

| 单位                     | 时间间隔 |
| ------------------------ | -------- |
| `y`、`year`、`years`     | 年       |
| `M`、`month`、`months`   | 月       |
| `d`、`day`、`days`       | 天       |
| `w`、`week`、`weeks`     | 周       |
| `h`、`hour`、`hours`     | 小时     |
| `m`、`minute`、`minutes` | 分钟     |
| `s`、`second`、`seconds` | 秒       |

要修改或偏移日期对象，请使用 `+` 或 `-` 运算符和时间间隔字符串。例如，`date + "1M"` 将日期加上 1 个月，而 `date - "2h"` 将日期减去 2 小时。

全局 [[函数]] `today()` 可用于获取当前日期，`now()` 可用于获取当前日期和时间。

- `now() + "1 day"` 返回执行时恰好 24 小时后的日期时间。
- `file.mtime > now() - "1 week"` 如果文件在上周内被修改，则返回 `true`。
- `date("2024-12-01") + "1M" + "4h" + "3m"` 返回表示 `2025-01-01 04:03:00` 的日期对象。
- 减去两个日期以获取它们之间的毫秒差异，例如 `now() - file.ctime`。
- 要获取带有时间的日期的日期部分，请使用 `datetime.date()`。
- 要格式化日期对象，请使用 `format()` 函数，例如 `datetime.format("YYYY-MM-DD")`。

### 比较运算符

比较运算符可用于比较数字或日期（Date）对象。相等和不相等可以与任何类型的值一起使用，而不仅仅是数字和日期。

| 运算符  | 描述                 |
| ------ | -------------------- |
| `==`   | 相等                 |
| `!=`   | 不相等               |
| `>`    | 大于                 |
| `<`    | 小于                 |
| `>=`   | 大于或等于            |
| `<=`   | 小于或等于            |

### 布尔运算符

布尔运算符可用于组合或反转逻辑值，结果为真或假值。

| 运算符 | 描述         |
| ------ | ------------ |
| `!`    | 逻辑非       |
| `&&`   | 逻辑与       |
| `\|\|`   | 逻辑或       |

## 函数

请参阅可用于公式和 [[视图|筛选器]] 的 [[函数|函数列表]]。

## 类型

数据库具有类型系统，供公式和筛选器将函数应用于属性时使用。

### 字符串、数字和布尔值

字符串、数字和布尔值是“原始”值，无需函数即可创建。

- 字符串用单引号或双引号括起来，例如 `"消息"`。
- 数字以数字形式书写，可能会为了清晰而用括号括起来。例如，`1` 或 `(2.5)`。
- 布尔值写为 `true` 或 `false`，不带引号。

### 日期和时间间隔

日期表示特定日期，或根据用于创建它们的函数而定的日期和时间，或分配给 [[属性]] 的类型。

- 要构造日期，请使用 `date` 函数，例如 `date("2025-01-01 12:00:00")`
- 要修改日期，请加上或减去一段时间间隔，例如 `now() + "1 hour"` 或 `today() + "7d"`
- 使用比较运算符（例如 `>` 或 `<`）和算术运算符（例如，`(now() + "1d") - now()` 返回 `86400000` 毫秒）比较日期。
- 要提取日期的某些部分，请使用可用字段（`now().hour`），或便利函数（`now.time()`）。
- 日期对象上可用许多其他 [[函数|字段和函数]]。

### 对象和列表

- 使用 `list()` 函数将单个元素转换为列表。这对于可能包含列表或单一值混合的属性特别有用。
- 使用方括号和基于 0 的索引访问列表元素。例如，`property[0]` 返回列表中的第一个元素。
- 使用方括号和元素名称或点表示法访问对象元素。例如，`property.子属性` 或 `property["子属性"]`。

### 文件和链接

[[链接笔记|维基链接]] 在 [[属性|元数据属性]] 中会自动识别为链接对象。链接将在 [[视图]] 中呈现为可点击的链接。

- 要构造链接，请使用全局 `link` [[函数]]，例如 `link("文件名称")` 或 `link("https://obsidian.md")`。
- 你可以从任何字符串创建链接，例如 `link(file.ctime.date().toString())`。
- 要设置显示文本，请作为第二个参数传入可选字符串或图标，例如 `link("文件名称", "显示名称")` 或 `link("文件名称", icon("plus"))`。

文件对象可以使用 `file.asLink()` 转换为链接，显示文本可选。

链接可以使用 `==` 和 `!=` 进行比较。只要它们指向相同的文件，或者在查找时文件不存在，它们就是等效的；它们的链接文本必须完全相同。

链接可以与文件（例如 `file` 或 `this`）进行比较。如果链接解析到该文件，则它们将相等。例如，`作者 == this`。

链接还可以在列表包含中检查，例如 `作者.contains(this)`。
